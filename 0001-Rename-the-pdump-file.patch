From 8aa4af6570b72a17827441b424248b9fb43cf543 Mon Sep 17 00:00:00 2001
From: William Douglas <william.douglas@intel.com>
Date: Thu, 29 Jun 2023 11:31:25 -0700
Subject: [PATCH] Rename the pdump file

Because the binary is named `emacs-x11`, the pdump file needs to be
renamed from `emacs` to `emacs-x11`. This change fixes operation of the
`emacs` package as well, because it has been patched to run `emacs-x11`
if installed.

Signed-off-by: William Douglas <william.douglas@intel.com>
---
 Makefile.in     | 2 +-
 lisp/loadup.el  | 4 ++--
 src/Makefile.in | 4 ++--
 src/emacs.c     | 2 +-
 4 files changed, 6 insertions(+), 6 deletions(-)

diff --git a/Makefile.in b/Makefile.in
index f5fda0e..d1fff43 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -622,7 +622,7 @@ ifeq (${DUMPING},pdumper)
 ifeq (${HAVE_BE_APP},yes)
 	${INSTALL_DATA} src/Emacs.pdmp "$(DESTDIR)${libexecdir}/emacs/${version}/${configuration}"/Emacs.pdmp
 endif
-	${INSTALL_DATA} src/emacs.pdmp "$(DESTDIR)${libexecdir}/emacs/${version}/${configuration}"/emacs-${EMACS_PDMP}
+	${INSTALL_DATA} src/emacs-x11.pdmp "$(DESTDIR)${libexecdir}/emacs/${version}/${configuration}"/emacs-x11-${EMACS_PDMP}
 endif
 	-chmod 755 "$(DESTDIR)${bindir}/$(EMACSFULL)"
 ifndef NO_BIN_LINK
diff --git a/lisp/loadup.el b/lisp/loadup.el
index 1cc7034..f3d92c2 100644
--- a/lisp/loadup.el
+++ b/lisp/loadup.el
@@ -547,7 +547,7 @@ lost after dumping")))
 
 
 (if dump-mode
-    (let ((output (cond ((equal dump-mode "pdump") "emacs.pdmp")
+    (let ((output (cond ((equal dump-mode "pdump") "emacs-x11.pdmp")
                         ((equal dump-mode "dump") "emacs")
                         ((equal dump-mode "bootstrap") "emacs")
                         ((equal dump-mode "pbootstrap") "bootstrap-emacs.pdmp")
@@ -600,7 +600,7 @@ lost after dumping")))
                               t)
             (when (equal dump-mode "pdump")
               (message "Adding name %s" (concat name ".pdmp"))
-              (add-name-to-file (expand-file-name "emacs.pdmp"
+              (add-name-to-file (expand-file-name "emacs-x11.pdmp"
                                                   invocation-directory)
                                 (expand-file-name (concat name ".pdmp")
                                                   invocation-directory)
diff --git a/src/Makefile.in b/src/Makefile.in
index c29c375..f2db7b6 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -385,7 +385,7 @@ DO_CODESIGN=$(patsubst aarch64-apple-darwin%,yes,@configuration@)
 bootstrap_exe = ../src/bootstrap-emacs$(EXEEXT)
 ifeq ($(DUMPING),pdumper)
 bootstrap_pdmp := bootstrap-emacs.pdmp # Keep in sync with loadup.el
-pdmp := emacs.pdmp
+pdmp := emacs-x11.pdmp
 else
 bootstrap_pdmp :=
 pdmp :=
@@ -749,7 +749,7 @@ ns-app: emacs$(EXEEXT) $(pdmp)
 mostlyclean:
 	rm -f temacs$(EXEEXT) core ./*.core \#* ./*.o
 	rm -f dmpstruct.h
-	rm -f emacs.pdmp
+	rm -f emacs-x11.pdmp
 	rm -f ../etc/DOC
 	rm -f bootstrap-emacs$(EXEEXT) $(bootstrap_pdmp)
 	rm -f emacs-$(version)$(EXEEXT)
diff --git a/src/emacs.c b/src/emacs.c
index e63b092..5ddba05 100644
--- a/src/emacs.c
+++ b/src/emacs.c
@@ -871,7 +871,7 @@ load_pdump (int argc, char **argv)
 #ifdef NS_SELF_CONTAINED
     "Emacs"
 #else
-    "emacs"
+    "emacs-x11"
 #endif
     ;
 
-- 
2.41.0

